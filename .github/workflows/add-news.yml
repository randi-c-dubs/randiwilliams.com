name: Add News Item to Website

on:
  issues:
    types: [labeled]

jobs:
  add_news:
    if: contains(github.event.issue.labels.*.name, 'news')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Extract issue content
        id: extract
        run: |
          echo "YEAR=$(echo "$BODY" | grep -A 1 '### Year' | tail -n 1)" >> $GITHUB_ENV
          echo "TITLE=$(echo "$BODY" | grep -A 1 '### Title' | tail -n 1)" >> $GITHUB_ENV
          echo "URL=$(echo "$BODY" | grep -A 1 '### URL' | tail -n 1)" >> $GITHUB_ENV
          echo "SOURCE=$(echo "$BODY" | grep -A 1 '### Source' | tail -n 1)" >> $GITHUB_ENV
          echo "CAT=$(echo "$BODY" | grep -A 1 '### Category' | tail -n 1)" >> $GITHUB_ENV

      - name: Add news snippet
        run: |
          case "$CAT" in
            Award)   ICON="images/1895474.png" ;;
            Video)   ICON="images/711245.png" ;;
            Audio)   ICON="images/7422028.png" ;;
            Article) ICON="images/60492.png" ;;
            *)       ICON="images/60492.png" ;;
          esac

          SNIPPET="<b>
            <span style=\"font-weight:700;\">
              <span class=\"u-file-icon u-icon\">
                <img src=\"$ICON\" alt=\"\">
              <\/span> $YEAR\&nbsp;
            <\/span>
            <b>
              <span style=\"font-weight: 400;\">
                <span style=\"background-image: none; padding: 0px; font-weight: 700;\">
                  <a href=\"$URL\" target=\"_blank\" class=\"u-active-none u-border-none u-btn u-button-style u-hover-none u-none u-text-palette-1-base\">
                    $TITLE
                  <\/a>
                <\/span>
                <span style=\"font-weight: 400;\">\&nbsp;- $SOURCE<\/span>
                <br>
              <\/span>
            <\/b>
          <\/b>"

          sed -i "/<!-- NEWS-START -->/a $SNIPPET" index.html

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add index.html
          git commit -m "Add news: $TITLE ($YEAR)"
          git push
